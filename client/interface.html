<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Geometry of Now</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.2/socket.io.min.js"></script>
  <script src="https://npmcdn.com/draggabilly@2.1/dist/draggabilly.pkgd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/0.9.0/Tone.js"></script>
  <script src="./StartAudioContext.js"></script>
  <script src="./Interface.js"></script>
  <link rel="stylesheet" href="./examples.css">
  <link rel="stylesheet" href="./main.css">
</head>
<body>
  <section class="loops-container">
    <div id="loop-0" class="loop drag-and-drop" data-row="0">
      <span class="loop-name">synth_loop.wav</span>
      <input type="number" value="100" class="loop-bpm">
      <span class="loop-length">4m</span>
      <input type="checkbox" class="loop-beatgrid-enabled" id="loop-beatgrid-enabled-0"><label for="loop-beatgrid-enabled-0" class="loop-beatgrid-enabled-button">Beatgrid</label>
      <button class="loop-play"><img src="./images/play.svg"/></button>
      <button class="loop-stop hidden"><img src="./images/stop.svg"/></button>
      <input type="checkbox" class="loop-autostart" id="loop-autostart-0"><label for="loop-autostart-0" class="loop-autostart-button">Autostart</label>
    </div>
    <div id="loop-1" class="loop drag-and-drop" data-row="1">
      <span class="loop-name">kick_loop.wav</span>
      <input type="number" value="100" class="loop-bpm">
      <span class="loop-length">4m</span>
      <input type="checkbox" class="loop-beatgrid-enabled" id="loop-beatgrid-enabled-1"><label for="loop-beatgrid-enabled-1" class="loop-beatgrid-enabled-button">Beatgrid</label>
      <button class="loop-play"><img src="./images/play.svg"/></button>
      <button class="loop-stop hidden"><img src="./images/stop.svg"/></button>
      <input type="checkbox" class="loop-autostart" id="loop-autostart-1"><label for="loop-autostart-1" class="loop-autostart-button">Autostart</label>
    </div>
  </section>
  <section class="beatgrid" id="beatgrid">
  </section>
  <section class="effects">
  </section>
  <section class="controls">
    <button class="start-stop" id="start">Start</button>
    <button class="start-stop hidden" id="stop">Stop</button>
    <label class="bpm-label" for="bpm-input">BPM</label>
    <input value="100" type="number" id="bpm-input" class="bpm-input" min="30" max="250">
  </section>
  <script>
    var masterStartTime;
    var gain = new Tone.Gain({
      gain: 0.5
    }).toMaster();

    // var filter = new Tone.Filter(15000, "lowpass").connect(gain);

    //loops
    var players = new Array(2);
    players[0] = new Tone.Player({
      url: './sounds/synth_loop.wav',
      loop: true,
      loopStart: '0m',
      loopEnd: '4m',
      overlap: 0.1,
      grainSize: 0.2,
      retrigger: false
    }).toMaster();
    players[1] = new Tone.Player({
      url: './sounds/kick_loop.wav',
      loop: true,
      loopStart: '0m',
      loopEnd: '4m',
      overlap: 0.1,
      grainSize: 0.2,
      retrigger: false
    }).toMaster();
    // players.push(synthLoop);
    // players.push(kickLoop);

    var sendToBeatgrid = 0; //index of player being sent to beatgrid
    //beatgrid
    var sequence = new Tone.Sequence(function(time, column) {
      $(".pad-state").removeClass("current-step");
      $(".pad-state").each(function(index) {
        if ($(this).data("column") === column) {
          $(this).addClass("current-step");
          if ($(this).prop('checked') == true) {
            var row = $(this).data('row');
            var toneTime = new Tone.Time(time);
            // players[sendToBeatgrid].scrub(row+"*16n", time);
            // console.log("starting player in sequence at row", sendToBeatgrid);
            players[sendToBeatgrid].start(time, row+"*16n", "16n");
            // env.triggerAttackRelease("16n - 64n", time);
          }
        }
      });
    }, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], "16n");

    Tone.Transport.bpm.value = 100;
    Tone.Transport.start();

    function sendLoopToBeatgrid(rowNumber) {
      var offset = new Tone.Time(Tone.TransportTime().toSeconds());
      offset.sub(masterStartTime);

      var startTime = new Tone.Time(offset.toSeconds());
      startTime.quantize('16n');
      if (startTime.toSeconds() < offset.toSeconds()) {
        startTime.add('16n');
      }
      startTime.add(masterStartTime);

      var quantizedOffset = new Tone.Time(offset.toSeconds());
      quantizedOffset.quantize('1m');
      if (quantizedOffset.toSeconds() > offset.toSeconds()) {
        quantizedOffset.sub('1m');
      }
      
      var startOffset = new Tone.Time(startTime.toSeconds() - quantizedOffset.toSeconds());

      players[rowNumber].stop();
      players[rowNumber].loop = false;
      players[rowNumber].loopStart = 0;
      players[rowNumber].loopEnd = 0;
      sendToBeatgrid = rowNumber;
      sequence.start(startTime.toSeconds(), startOffset.toSeconds()); 
    }

    function syncLoopToMasterAndStart(rowNumber) {
      var offset = new Tone.Time(Tone.TransportTime().toSeconds());
      offset.sub(masterStartTime);

      var quantizedOffset = new Tone.Time(offset.toSeconds());
      quantizedOffset.quantize('1m');
      if (quantizedOffset.toSeconds() < offset.toSeconds()) {
        quantizedOffset.add('1m');
      }

      var startTime = new Tone.Time(masterStartTime.toSeconds());
      startTime.add(quantizedOffset);
      players[rowNumber].loop = true;
      players[rowNumber].loopStart = 0;
      players[rowNumber].loopEnd = '4m';
      console.log("starting player at row", rowNumber);
      players[rowNumber].start(startTime);
    }

    function syncLoopToMasterWithOffset(rowNumber) {
      var stopBeatgridOffset = new Tone.Time(Tone.TransportTime().toSeconds());
      stopBeatgridOffset.sub(masterStartTime);

      var quantizedStopBeatgridOffset = new Tone.Time(stopBeatgridOffset.toSeconds());
      quantizedStopBeatgridOffset.quantize('16n');
      if (quantizedStopBeatgridOffset.toSeconds() < stopBeatgridOffset.toSeconds()) {
        quantizedStopBeatgridOffset.add('16n');
      }

      var stopTime = new Tone.Time(masterStartTime.toSeconds() + quantizedStopBeatgridOffset.toSeconds());

      var measureStart = new Tone.Time(stopBeatgridOffset.toSeconds());
      measureStart.quantize('1m');
      if (measureStart.toSeconds() > quantizedStopBeatgridOffset.toSeconds()) {
        measureStart.sub('1m');
      }

      var offset = new Tone.Time(stopTime.toSeconds() - measureStart.toSeconds());

      players[rowNumber].stop();
      players[rowNumber].loop = true;
      players[rowNumber].loopStart = 0;
      players[rowNumber].loopEnd = '4m';
      players[rowNumber].start(stopTime.toSeconds(), offset.toSeconds());
    }

    $(function(){
      //event handlers

      $("#bpm-input").change(function() {
        Tone.Transport.bpm.value = parseInt($(this).val());
        players.forEach(function(player, index) {
          player.playbackRate = Tone.Transport.bpm.value 
          / parseFloat($('#loop-' + index + ' .loop-bpm').val());
        });
      });

      $(".loop-bpm").change(function() {
        var rowNumber = $(this).parent().data("row");
        players[rowNumber].playbackRate = Tone.Transport.bpm.value 
          / parseFloat($(this).val());
        var sampleLengthInSeconds = players[rowNumber].buffer.duration / players[rowNumber].playbackRate;
        var sampleLength = new Tone.Time(sampleLengthInSeconds);
        $("#loop-" + rowNumber + " .loop-length").text(sampleLength.quantize("1m").toNotation());
      });

      $(".loop-beatgrid-enabled").change(function() {
        var isPlaying = $(this).siblings(".loop-play").hasClass("hidden");
        if (this.checked && isPlaying) {
          var beatgridsEnabled = $(".loop-beatgrid-enabled").not(this);
          beatgridsEnabled.each(function(i) {
            if (this.checked) {
              $(this).prop("checked", false);
              if ($(this).siblings(".loop-play").hasClass("hidden")) {
                var rowNumber = $(this).parent().data("row");
                syncLoopToMasterWithOffset(rowNumber);
              }
            }
          });
          var rowNumber = $(this).parent().data("row");
          sendLoopToBeatgrid(rowNumber);

          // var startBeatgridTime = new Tone.Time(Tone.TransportTime().toSeconds());
          // var quantizedStartTime = new Tone.Time(Tone.TransportTime().toSeconds());
          // quantizedStartTime.quantize('1m');
          // if (startBeatgridTime.toSeconds() < quantizedStartTime.toSeconds()) {
          //   quantizedStartTime.sub('1m');
          // }
          // var offset = new Tone.Time(startBeatgridTime.toSeconds() - quantizedStartTime.toSeconds());

          // players[rowNumber].stop();
          // players[rowNumber].loop = false;
          // players[rowNumber].loopStart = 0;
          // players[rowNumber].loopEnd = 0;
          // sendToBeatgrid = rowNumber;
          // sequence.start(Tone.TransportTime().toSeconds(), offset.toSeconds());
        } else {

          var rowNumber = $(this).parent().data("row");
          sequence.stop();
          players[rowNumber].stop();
          if (isPlaying) {
            syncLoopToMasterWithOffset(rowNumber);
          }

          //start at nearest measure divisible by loop length
        }

      });
    });
  </script>
  <script>
    function renderGrid(rows, columns) {
      for (var i = 0; i < rows; i++) {
        var rowContainer = document.createElement("div");
        rowContainer.className = "row";
        rowContainer.id = "row-" + i;
        rowContainer.setAttribute("data-row", i);
        $("#beatgrid").append($(rowContainer));
        for (var j = 0; j < columns; j++) {
          var button = document.createElement("input");
          var label = document.createElement("label");
          button.type = "checkbox";
          button.id = "button-" + i + "-" + j;
          button.className = "pad-state";
          $(button).data("row", i);
          $(button).data("column", j);
          label.htmlFor = button.id;
          label.className = "pad";
          $(rowContainer).append($(button));
          $(rowContainer).append($(label));
        }
      }
    }

    $(function(){
      renderGrid(4, 16);

      $(".pad-state").change(function() {
        var column = $(this).data("column");
        var row = $(this).data("row");
        $(".pad-state").each(function(index) {
          if ($(this).data("row") !== row && $(this).data("column") === column) {
            $(this).prop("checked", false);
          }
        });
      });

      $("#start").click(function() {
        masterStartTime = new Tone.Time(Tone.TransportTime().toSeconds());
        $(this).addClass("hidden");
        $("#stop").removeClass("hidden");
        $(".loop-beatgrid-enabled").prop("checked", false);
        players.forEach(function(player, index) {
          if ($("#loop-" + index + " .loop-autostart").prop("checked")) {
            console.log("starting player at row", index);
            player.start();
            $("#loop-" + index + " .loop-play").addClass("hidden");
            $("#loop-" + index + " .loop-stop").removeClass("hidden");
          }
        });
      });

      $("#stop").click(function() {
        $(this).addClass("hidden");
        $("#start").removeClass("hidden");
        players.forEach(function(player) {
          player.stop();
        });

        $(".loop-stop").addClass("hidden");
        $(".loop-play").removeClass("hidden");
      });

      $(".loop-play").click(function() {
        //check if beatgrid is enabled, if so, want to initalize beatgrid instead
        var rowNumber = $(this).parent().data("row");
        $(this).addClass("hidden");
        $(this).siblings(".loop-stop").removeClass("hidden");
        if ($("#stop").hasClass("hidden")) {
          masterStartTime = new Tone.Time(Tone.TransportTime().toSeconds());
          $("#start").addClass("hidden");
          $("#stop").removeClass("hidden");
          players[rowNumber].loop = true;
          players[rowNumber].loopStart = 0;
          players[rowNumber].loopEnd = '4m';
          console.log("starting player at row", rowNumber);
          players[rowNumber].start();
        } else {
          if ($("#loop-" + rowNumber + " .loop-beatgrid-enabled").prop("checked")) {
            sendLoopToBeatgrid(rowNumber);
          } else {
            syncLoopToMasterAndStart(rowNumber);
          }
        }
      });

      $(".loop-stop").click(function() {
        var rowNumber = $(this).parent().data("row");
        if ($("#loop-" + rowNumber + " .loop-beatgrid-enabled").prop("checked")) {
          sequence.stop();
          players[rowNumber].stop();
        } else {
          players[rowNumber].stop();
        }
        $(this).addClass("hidden");
        $(this).siblings(".loop-play").removeClass("hidden");
      });
    });
  </script>
  <script src="./web-audio-bpm.min.js"></script>
  <script src="./drag-and-drop3.js"></script>
</body>
</html>